<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="style.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
</head>

</head>
<body class="bg">

<header>
    <a href="#" class="name">HUNTRIX</a>
    <div class="menu-btn"></div>
    <div class="nav">
        <div class="nav-items">
            <a href="index.html">Home</a>
            <a href="character.html" target="_blank">Characters</a>
            <a href="Gallery.html" target="_blank">Gallery</a>
            <a href="#">Songs</a>
            <a href="about.html">About</a>
            <button> Download</button>
        </div>
    </div>
        <i class="fa fa-bars ham" id="openMenu"></i>
        <i class="fa fa-times " id="closeMenu"></i>
    
</header>
    <div class="wrapper">
     <form action="">
        <h1>Login</h1>
        <div class="input-box">
            <input type="text" placeholder="Username" required>
            <i class='bx  bxs-user'  ></i> 
        </div>
        <div class="input-box">
            <input type="password" placeholder="password" required>
            <i class='bx  bxs-lock'  ></i> 
        </div>
        <div class="rem-forgot">
            <label> <input type="checkbox">Remember Me </label>
            <a href="#">Forgot Password?</a>
        </div>
        <button type="submit" class="btn">Login</button>
        <div class="reglink">
            <p>Don't have an account? <a href="register.html">Register here!</a></p>

        </div>
    </form>
    </div>
    <script>

           const openMenu = document.getElementById('openMenu');
const closeMenu = document.getElementById('closeMenu');
const navItems = document.querySelector('.nav-items');

// Show menu
openMenu.addEventListener('click', () => {
  navItems.classList.add('active');
  openMenu.style.display = 'none';
  closeMenu.style.display = 'block';
});

// Hide menu
closeMenu.addEventListener('click', () => {
  navItems.classList.remove('active');
  closeMenu.style.display = 'none';
  openMenu.style.display = 'block';
});

// Optional: Close if nav item is clicked
navItems.addEventListener('click', (e) => {
  if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
    navItems.classList.remove('active');
    closeMenu.style.display = 'none';
    openMenu.style.display = 'block';
  }
});
        console.log("Login script loaded ✅");

function hasSelectedCharacter() {
  // 1) explicit top-level selectedCharacter
  try {
    const sc = JSON.parse(localStorage.getItem("selectedCharacter") || "null");
    if (sc) return true;
  } catch (e) { /* ignore parse errors */ }

  // 2) try direct user object returned on login (data.user.character)
  try {
    const rawLogged = localStorage.getItem("loggedInUser");
    if (rawLogged) {
      const parsed = JSON.parse(rawLogged);
      if (parsed && (parsed.character || parsed.selectedCharacter)) return true;
    }
  } catch(e){}

  // 3) users map: users[username].character
  try {
    const users = JSON.parse(localStorage.getItem("users") || "null");
    if (users) {
      const keyCandidates = ["currentUser","loggedInUser","username"];
      for (const k of keyCandidates) {
        const raw = localStorage.getItem(k);
        if (!raw) continue;
        let uname = raw;
        try { const parsed = JSON.parse(raw); uname = parsed?.username || parsed?.name || parsed; } catch(_) { uname = raw; }
        if (users[uname] && users[uname].character) return true;
      }
      // if there's exactly one user and they have character
      const keys = Object.keys(users);
      if (keys.length === 1 && users[keys[0]].character) return true;
    }
  } catch(e) { /* ignore parse errors */ }

  // nothing found
  return false;
}

document.querySelector("form").addEventListener("submit", async function (e) {
  e.preventDefault();

  const form = e.target;
  const username = form.elements[0].value.trim();
  const password = form.elements[1].value;

  if (!username || !password) {
    alert("Please enter username and password.");
    return;
  }

  // disable UI to prevent double submits
  const submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('button');
  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = "Logging in..."; }

 try {
  const response = await fetch("https://huntrix-backend-0a1b.onrender.com/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

  const data = await response.json().catch(()=>({}));

  if (!response.ok) {
    alert(data.message || "Login failed — check credentials or server.");
    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = "Login"; }
    return;
  }

  const user = data.user || { username };
  localStorage.setItem("loggedInUser", JSON.stringify(user));
  localStorage.setItem("currentUser", JSON.stringify(user.username || username));

  // Update users map
  const users = JSON.parse(localStorage.getItem("users") || "{}");
  users[user.username] = { ...(users[user.username] || {}), ...user };
  localStorage.setItem("users", JSON.stringify(users));

  if (user.character) {
    localStorage.setItem("selectedCharacter", JSON.stringify(user.character));
  }

  if (hasSelectedCharacter()) {
    window.location.href = "dashboard.html";
  } else {
    window.location.href = "character-select.html";
  }
} catch (err) {
  console.error("Login error:", err);
  alert("Could not contact server. Try again later.");
  if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = "Login"; } 
}
});
    </script>

</body>
</html>